<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colapso Estelar - Estrella de Neutrones ‚Üí Agujero Negro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000; 
            font-family: 'Courier New', monospace;
            user-select: none;
        }
        canvas { display: block; }
        
        #info {
            position: absolute; top: 20px; left: 20px;
            color: #0ff; font-size: 12px;
            background: rgba(0, 10, 20, 0.85);
            padding: 15px 20px; 
            border: 1px solid #0ff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            pointer-events: none;
            min-width: 250px;
            transition: all 0.5s;
        }
        
        #info.collapsing {
            border-color: #ff6600;
            box-shadow: 0 0 30px rgba(255, 100, 0, 0.5);
        }
        
        .val { color: #0ff; font-weight: bold; margin-left: 8px; }
        .label { color: #888; font-size: 10px; letter-spacing: 1px; }
        .warning { color: #ff6b00; }
        
        #controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 10, 20, 0.9);
            padding: 20px 30px;
            border: 1px solid #0ff;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 150px;
        }
        
        .control-group label {
            color: #0ff;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            background: rgba(0, 255, 255, 0.2);
            outline: none;
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            background: #0ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #0ff;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #0ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #0ff;
        }
        
        button {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #0ff;
            color: #0ff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        button.active {
            background: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }
        
        button.collapse-btn {
            background: rgba(255, 100, 0, 0.2);
            border-color: #ff6600;
            color: #ff6600;
            font-size: 13px;
            font-weight: bold;
            padding: 12px 24px;
        }
        
        button.collapse-btn:hover {
            background: rgba(255, 100, 0, 0.4);
            box-shadow: 0 0 20px rgba(255, 100, 0, 0.7);
        }
        
        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        #instructions {
            position: absolute; top: 20px; right: 20px;
            color: #888;
            font-size: 11px;
            background: rgba(0, 10, 20, 0.85);
            padding: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            max-width: 220px;
        }
        
        #collapseWarning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 50, 0, 0.9);
            color: #fff;
            padding: 30px 40px;
            border: 3px solid #ff6600;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 100, 0, 0.8);
            display: none;
            z-index: 1000;
            animation: pulse 1s infinite;
        }
        
        #factBox {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 50, 100, 0.9);
            color: #fff;
            padding: 15px 25px;
            border: 2px solid #0ff;
            border-radius: 10px;
            font-size: 13px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        
        #factBox.show {
            opacity: 1;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        @keyframes shockwave {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }
        
        .shockwave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            border: 3px solid #ff6600;
            border-radius: 50%;
            animation: shockwave 2s ease-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="collapseWarning">‚ö†Ô∏è COLAPSO GRAVITACIONAL ‚ö†Ô∏è</div>
    
    <div id="factBox">üí° Las estrellas de neutrones giran hasta 700 veces por segundo</div>
    
    <div id="info">
        <div style="font-size: 14px; margin-bottom: 10px; color: #fff;">
            <span id="objectType">‚≠ê ESTRELLA DE NEUTRONES</span>
        </div>
        <div><span class="label">ESTADO:</span><span class="val" id="stateVal">ESTABLE</span></div>
        <div><span class="label">TIPO:</span><span class="val" id="typeVal">PULSAR</span></div>
        <div><span class="label">MASA (M‚òâ):</span><span class="val" id="massVal">1.8</span></div>
        <div><span class="label">RADIO (km):</span><span class="val" id="radiusVal">12</span></div>
        <div><span class="label">ROTACI√ìN (Hz):</span><span class="val" id="rotationVal">30</span></div>
        <div><span class="label">PART√çCULAS:</span><span class="val" id="partCount">2000</span></div>
        <div><span class="label">FPS:</span><span class="val" id="fps">60</span></div>
        <div style="margin-top: 10px;" id="specialInfo">
            <span class="label">üì° PULSOS:</span><span class="val">DETECTADOS</span>
        </div>
    </div>
    
    <div id="instructions">
        <strong style="color: #0ff;">CONTROLES:</strong><br>
        ‚Ä¢ Scroll: Zoom<br>
        ‚Ä¢ Click+Arrastrar: Rotar<br>
        ‚Ä¢ Espacio: Pausa<br>
        ‚Ä¢ <strong style="color: #ff6600;">E: COLAPSAR ‚ö†Ô∏è</strong><br>
        ‚Ä¢ G: Ondas gravitacionales<br>
        ‚Ä¢ L: Lente gravitacional<br><br>
        <span style="color: #ff6600; font-size: 9px;">Presiona E para iniciar el colapso gravitacional</span>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <div id="controls">
        <button id="collapseBtn" class="collapse-btn">INICIAR COLAPSO (E)</button>
        <button id="resetBtn">RESETEAR</button>
        <button id="pauseBtn">PAUSAR</button>
        <button id="gwBtn">ONDAS G (G)</button>
        <button id="lensBtn" class="active">LENTE G (L)</button>
    </div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { alpha: false });

// Estado global
let width, height, cx, cy;
let zoom = 1;
let paused = false;

// Nuevas caracter√≠sticas - AHORA SON PERMANENTES
let showGravitationalWaves = false;
let showGravitationalLensing = true; // Activado por defecto
let gravitationalWaves = [];
let ejectaParticles = [];
let gwWaveTimer = 0; // Timer para generar ondas peri√≥dicamente

// Estado de la simulaci√≥n
let isNeutronStar = true;
let isCollapsing = false;
let collapseProgress = 0;
const COLLAPSE_DURATION = 5000;
let collapseStartTime = 0;

// Par√°metros de estrella de neutrones
let neutronStar = {
    mass: 1.8,
    radius: 60,
    rotationSpeed: 30,
    rotation: 0,
    magneticField: true,
    pulsePhase: 0
};

// Par√°metros de agujero negro
const G = 1;
let M = 35;
let a = 0.99;
let scale = 7;
let rs, rPlus, rMinus, rErgosphere, rPhotonSphere, rISCO;

function updateBlackHolePhysics() {
    rs = 2 * G * M;
    const delta = 1 - a * a;
    rPlus = G * M * (1 + Math.sqrt(delta));
    rMinus = G * M * (1 - Math.sqrt(delta));
    rErgosphere = 2 * G * M;
    rPhotonSphere = rs * 1.5;
    rISCO = rs * (3 + Math.sqrt(9 - 8 * a * a)) / 2;
}

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    cx = width / 2;
    cy = height / 2;
    updateBlackHolePhysics();
}

window.addEventListener("resize", resize);
resize();

/* --- HECHOS CIENT√çFICOS --- */
const facts = [
    "üí° Una cucharada de estrella de neutrones pesa mil millones de toneladas",
    "üí° Los agujeros negros pueden girar al 99% de la velocidad de la luz",
    "üí° El tiempo se detiene en el horizonte de eventos",
    "üí° Las estrellas de neutrones tienen campos magn√©ticos billones de veces m√°s fuertes que la Tierra",
    "üí° Un agujero negro estelar se forma cuando una estrella >25 M‚òâ colapsa",
    "üí° Los p√∫lsares son los relojes m√°s precisos del universo",
    "üí° La ergosfera permite extraer energ√≠a de un agujero negro rotante",
    "üí° Durante el colapso se liberan neutrinos en cantidades masivas"
];

let currentFactIndex = 0;
let factTimer = 0;

function showFact(index) {
    const factBox = document.getElementById("factBox");
    factBox.textContent = facts[index];
    factBox.classList.add("show");
    
    setTimeout(() => {
        factBox.classList.remove("show");
    }, 4000);
}

/* --- ESTRELLAS DE FONDO --- */
const stars = Array.from({ length: 400 }, () => ({
    x: Math.random() * width,
    y: Math.random() * height,
    s: Math.random() * 1.5 + 0.5,
    opacity: Math.random() * 0.7 + 0.3,
    twinkle: Math.random() * Math.PI * 2,
    originalX: 0,
    originalY: 0
}));

stars.forEach(s => {
    s.originalX = s.x;
    s.originalY = s.y;
});

function drawStars(time) {
    stars.forEach(s => {
        let finalX = s.x;
        let finalY = s.y;
        
        // Lente gravitacional - EFECTO PERMANENTE cuando est√° activado
        if (showGravitationalLensing && !isNeutronStar) {
            const dx = s.x - cx;
            const dy = s.y - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const influence = rPhotonSphere * scale * zoom * 3;
            
            if (dist < influence && dist > 10) {
                const lensingFactor = (influence / dist) * 0.3;
                const angle = Math.atan2(dy, dx);
                finalX = cx + Math.cos(angle) * (dist + lensingFactor * 50);
                finalY = cy + Math.sin(angle) * (dist + lensingFactor * 50);
            }
        }
        
        const twinkle = Math.sin(s.twinkle + time * 0.001) * 0.3 + 0.7;
        ctx.globalAlpha = s.opacity * twinkle;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(finalX, finalY, s.s, s.s);
    });
    ctx.globalAlpha = 1;
}

/* --- ONDAS GRAVITACIONALES --- */
class GravitationalWave {
    constructor(time) {
        this.birthTime = time;
        this.maxRadius = Math.max(width, height);
    }
    
    draw(currentTime) {
        const age = currentTime - this.birthTime;
        const radius = age * 0.3;
        
        if (radius > this.maxRadius) return false;
        
        const alpha = Math.max(0, 1 - radius / this.maxRadius);
        
        ctx.strokeStyle = `rgba(100, 200, 255, ${alpha * 0.3})`;
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 10]);
        
        ctx.beginPath();
        ctx.arc(cx, cy, radius * zoom, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.setLineDash([]);
        
        return true;
    }
}

/* --- PART√çCULAS EYECTADAS --- */
class EjectaParticle {
    constructor() {
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 4;
        
        this.x = cx;
        this.y = cy;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.size = Math.random() * 3 + 1;
        this.life = 1;
        this.color = Math.random() > 0.5 ? 
            [255, 150, 50] : [255, 200, 100];
    }
    
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.01;
        this.vy += 0.05; // Gravedad
    }
    
    draw() {
        if (this.life <= 0) return false;
        
        ctx.globalAlpha = this.life;
        ctx.fillStyle = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
        ctx.shadowBlur = 10;
        ctx.shadowColor = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
        
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size * zoom, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
        
        return true;
    }
}

/* --- ESTRELLA DE NEUTRONES --- */
class NeutronStarParticle {
    constructor() { this.reset(); }
    
    reset() {
        this.angle = Math.random() * Math.PI * 2;
        this.r = neutronStar.radius * (0.7 + Math.random() * 0.3);
        this.orbitSpeed = (Math.random() - 0.5) * 0.02;
        this.size = Math.random() * 2 + 1;
        this.color = Math.random() > 0.5 ? 0 : 1;
    }
    
    update() {
        this.angle += this.orbitSpeed;
        
        if (isCollapsing) {
            this.r -= (this.r / neutronStar.radius) * 2 * collapseProgress;
            this.orbitSpeed *= 1.05;
        }
    }
    
    draw() {
        const x = cx + Math.cos(this.angle) * this.r * zoom;
        const y = cy + Math.sin(this.angle) * this.r * zoom;
        
        if (this.color === 0) {
            ctx.fillStyle = `rgba(100, 150, 255, ${0.8 - collapseProgress * 0.5})`;
        } else {
            ctx.fillStyle = `rgba(255, 255, 255, ${0.9 - collapseProgress * 0.6})`;
        }
        
        ctx.shadowBlur = 3 * zoom;
        ctx.shadowColor = this.color === 0 ? "#6496ff" : "#ffffff";
        
        ctx.beginPath();
        ctx.arc(x, y, this.size * zoom, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
    }
}

let neutronParticles = Array.from({ length: 2000 }, () => new NeutronStarParticle());

function drawNeutronStar(time) {
    neutronStar.rotation += neutronStar.rotationSpeed * 0.001;
    neutronStar.pulsePhase += 0.1;
    
    const visualRadius = neutronStar.radius * zoom * (1 - collapseProgress * 0.8);
    
    // N√∫cleo
    const coreGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, visualRadius);
    coreGrad.addColorStop(0, `rgba(255, 255, 255, ${0.9 - collapseProgress * 0.5})`);
    coreGrad.addColorStop(0.3, `rgba(200, 220, 255, ${0.7 - collapseProgress * 0.4})`);
    coreGrad.addColorStop(0.6, `rgba(100, 150, 255, ${0.5 - collapseProgress * 0.3})`);
    coreGrad.addColorStop(1, "transparent");
    
    ctx.fillStyle = coreGrad;
    ctx.beginPath();
    ctx.arc(cx, cy, visualRadius, 0, Math.PI * 2);
    ctx.fill();
    
    // Campo magn√©tico
    if (neutronStar.magneticField && !isCollapsing) {
        ctx.strokeStyle = `rgba(100, 255, 200, 0.3)`;
        ctx.lineWidth = 2;
        
        for (let i = 0; i < 4; i++) {
            const angle = neutronStar.rotation + (i * Math.PI / 2);
            const x1 = cx + Math.cos(angle) * visualRadius;
            const y1 = cy + Math.sin(angle) * visualRadius;
            const x2 = cx + Math.cos(angle) * visualRadius * 2;
            const y2 = cy + Math.sin(angle) * visualRadius * 2;
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.quadraticCurveTo(cx, cy - visualRadius * 3, x2, y2);
            ctx.stroke();
        }
    }
    
    // Haz del pulsar
    const pulseIntensity = Math.sin(neutronStar.pulsePhase) * 0.5 + 0.5;
    if (pulseIntensity > 0.7 && !isCollapsing) {
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(neutronStar.rotation);
        
        const beamGrad = ctx.createLinearGradient(0, 0, visualRadius * 5, 0);
        beamGrad.addColorStop(0, `rgba(100, 200, 255, ${pulseIntensity * 0.6})`);
        beamGrad.addColorStop(0.5, `rgba(100, 200, 255, ${pulseIntensity * 0.3})`);
        beamGrad.addColorStop(1, "transparent");
        
        ctx.fillStyle = beamGrad;
        ctx.fillRect(0, -10, visualRadius * 5, 20);
        
        ctx.restore();
    }
    
    // Part√≠culas
    neutronParticles.forEach(p => {
        p.update();
        p.draw();
    });
}

/* --- JETS RELATIVISTAS --- */
class Jet {
    constructor(dir) {
        this.dir = dir;
        this.reset();
    }
    
    reset() {
        this.x = (Math.random() - 0.5) * 12;
        this.y = 0;
        this.z = Math.random() * 30;
        this.speed = 5 + Math.random() * 8;
        this.life = 1;
        this.thickness = Math.random() * 2 + 1;
    }
    
    update() {
        this.z += this.speed;
        this.life -= 0.012;
        if (this.life <= 0) this.reset();
    }
    
    draw() {
        const perspective = 500 / (500 + this.z);
        const sx = cx + this.x * perspective * zoom;
        const sy = cy - (this.z * this.dir * scale * 0.9 * zoom);
        
        const alpha = this.life * 0.5 * (1 - collapseProgress + 1);
        const size = this.thickness * perspective * zoom;
        
        const gradient = ctx.createRadialGradient(sx, sy, 0, sx, sy, size * 4);
        gradient.addColorStop(0, `rgba(100, 180, 255, ${alpha})`);
        gradient.addColorStop(0.5, `rgba(0, 120, 255, ${alpha * 0.3})`);
        gradient.addColorStop(1, "transparent");
        
        ctx.fillStyle = gradient;
        ctx.fillRect(sx - size * 4, sy - size * 4, size * 8, size * 8);
    }
}

let jets = Array.from({ length: 100 }, (_, i) => new Jet(i % 2 === 0 ? 1 : -1));

/* --- DISCO DE ACRECI√ìN --- */
class AccretionParticle {
    constructor() { this.reset(); }
    
    reset() {
        this.r = rISCO * 0.9 + Math.random() * rISCO * 4;
        this.theta = Math.random() * Math.PI * 2;
        const orbitalVel = Math.sqrt(G * M / this.r);
        this.speed = orbitalVel * 0.02 * (1 + a * 0.3);
        this.size = Math.random() * 2 + 0.5;
        this.z = (Math.random() - 0.5) * rISCO * 0.15;
    }
    
    update() {
        this.theta += this.speed;
        const infall = 0.01 * Math.pow(rISCO / this.r, 2);
        this.r -= infall;
        if (this.r < rPlus * 1.2) this.reset();
    }
    
    draw() {
        const sinT = Math.sin(this.theta);
        const cosT = Math.cos(this.theta);
        
        const lensing = rPhotonSphere / Math.max(this.r, rPhotonSphere);
        const verticalCompression = 0.2 + lensing * 0.3;
        
        const x = cx + cosT * this.r * scale * zoom;
        const y = cy + sinT * verticalCompression * this.r * scale * zoom - 
                  (lensing * scale * zoom * 3 * (sinT > 0 ? 1 : -0.3));
        
        const doppler = 1 + sinT * 0.5;
        const temp = Math.min(1, (rISCO * 2) / this.r);
        
        const r = 255 * doppler * temp;
        const g = (120 + 100 * temp) * doppler;
        const b = (30 + 40 * (1 - temp)) * doppler;
        
        const alpha = Math.min(1, doppler * (1 - this.z * this.z / (rISCO * rISCO))) * 
                      (1 - collapseProgress + 1);
        
        ctx.globalAlpha = alpha;
        ctx.fillStyle = `rgb(${r|0},${g|0},${b|0})`;
        
        if (temp > 0.7) {
            ctx.shadowBlur = 5 * temp * zoom;
            ctx.shadowColor = `rgb(${r|0},${g|0},${b|0})`;
        }
        
        ctx.beginPath();
        ctx.arc(x, y, this.size * zoom, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;
    }
}

let accretionParticles = [];

/* --- AGUJERO NEGRO --- */
function drawBlackHole() {
    const horizonR = rPlus * scale * zoom;
    const photonR = rPhotonSphere * scale * zoom;
    
    const opacity = 1 - collapseProgress + 1;
    
    // Sombra
    const shadowGrad = ctx.createRadialGradient(cx, cy, horizonR, cx, cy, photonR);
    shadowGrad.addColorStop(0, `rgba(0, 0, 0, ${opacity})`);
    shadowGrad.addColorStop(0.7, `rgba(20, 10, 0, ${0.8 * opacity})`);
    shadowGrad.addColorStop(1, "transparent");
    
    ctx.fillStyle = shadowGrad;
    ctx.beginPath();
    ctx.arc(cx, cy, photonR, 0, Math.PI * 2);
    ctx.fill();
    
    // Anillo de fotones
    ctx.strokeStyle = `rgba(255, 200, 100, ${0.3 * opacity})`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(cx, cy, photonR, 0, Math.PI * 2);
    ctx.stroke();
    
    // Horizonte de eventos
    const horizonGlow = ctx.createRadialGradient(cx, cy, horizonR * 0.95, cx, cy, horizonR * 1.05);
    horizonGlow.addColorStop(0, "black");
    horizonGlow.addColorStop(0.5, `rgba(255, 100, 0, ${0.6 * opacity})`);
    horizonGlow.addColorStop(1, "transparent");
    
    ctx.fillStyle = horizonGlow;
    ctx.beginPath();
    ctx.arc(cx, cy, horizonR * 1.05, 0, Math.PI * 2);
    ctx.fill();
    
    // Centro
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.arc(cx, cy, horizonR, 0, Math.PI * 2);
    ctx.fill();
}

/* --- COLAPSO --- */
function startCollapse() {
    if (isCollapsing || !isNeutronStar) return;
    
    isCollapsing = true;
    collapseStartTime = performance.now();
    
    document.getElementById("collapseWarning").style.display = "block";
    document.getElementById("info").classList.add("collapsing");
    document.getElementById("collapseBtn").disabled = true;
    
    document.getElementById("stateVal").textContent = "COLAPSANDO";
    document.getElementById("stateVal").style.color = "#ff6600";
    
    // Crear onda gravitacional inicial
    if (showGravitationalWaves) {
        gravitationalWaves.push(new GravitationalWave(performance.now()));
    }
    
    // Crear shockwave visual
    const shockwave = document.createElement("div");
    shockwave.className = "shockwave";
    document.body.appendChild(shockwave);
    setTimeout(() => shockwave.remove(), 2000);
    
    // Eyectar part√≠culas
    for (let i = 0; i < 50; i++) {
        ejectaParticles.push(new EjectaParticle());
    }
    
    setTimeout(() => {
        document.getElementById("collapseWarning").style.display = "none";
    }, 2000);
    
    // Mostrar hecho cient√≠fico
    showFact(7);
}

function updateCollapse(currentTime) {
    if (!isCollapsing) return;
    
    const elapsed = currentTime - collapseStartTime;
    collapseProgress = Math.min(elapsed / COLLAPSE_DURATION, 1);
    
    neutronStar.mass = 1.8 + (M - 1.8) * collapseProgress;
    neutronStar.radius = 60 * (1 - collapseProgress * 0.9);
    neutronStar.rotationSpeed = 30 * (1 + collapseProgress * 20);
    
    document.getElementById("massVal").textContent = neutronStar.mass.toFixed(1);
    document.getElementById("radiusVal").textContent = neutronStar.radius.toFixed(1);
    document.getElementById("rotationVal").textContent = Math.floor(neutronStar.rotationSpeed);
    
    // Generar ondas gravitacionales durante el colapso si est√°n activadas
    if (showGravitationalWaves && Math.random() < 0.05) {
        gravitationalWaves.push(new GravitationalWave(currentTime));
    }
    
    if (collapseProgress >= 1) {
        isCollapsing = false;
        isNeutronStar = false;
        
        document.getElementById("objectType").textContent = "‚ö´ AGUJERO NEGRO KERR";
        document.getElementById("stateVal").textContent = "ACTIVO";
        document.getElementById("stateVal").style.color = "#0ff";
        document.getElementById("typeVal").textContent = "SINGULARIDAD";
        document.getElementById("massVal").textContent = M;
        document.getElementById("radiusVal").textContent = (rPlus * 2.95).toFixed(1);
        document.getElementById("rotationVal").textContent = "N/A";
        document.getElementById("specialInfo").innerHTML = 
            '<span class="label warning">‚ö† ERGOSFERA:</span><span class="val warning">ACTIVA</span>';
        
        accretionParticles = Array.from({ length: 3000 }, () => new AccretionParticle());
        
        document.getElementById("info").classList.remove("collapsing");
        
        // Mostrar hecho sobre agujeros negros
        setTimeout(() => showFact(2), 1000);
    }
}

/* --- LOOP PRINCIPAL --- */
let lastTime = 0;
let frameCount = 0;
let lastFpsUpdate = 0;

function animate(time) {
    if (paused) {
        requestAnimationFrame(animate);
        return;
    }
    
    const dt = time - lastTime;
    lastTime = time;
    
    updateCollapse(time);
    
    // Motion blur
    ctx.fillStyle = "rgba(0, 0, 0, 0.15)";
    ctx.fillRect(0, 0, width, height);
    
    drawStars(time);
    
    // Ondas gravitacionales PERMANENTES - se generan continuamente cuando est√° activado
    if (showGravitationalWaves) {
        // Generar nuevas ondas peri√≥dicamente
        gwWaveTimer++;
        if (gwWaveTimer > 60 && !isNeutronStar) { // Cada ~1 segundo cuando es agujero negro
            gravitationalWaves.push(new GravitationalWave(time));
            gwWaveTimer = 0;
        }
        
        // Dibujar todas las ondas activas
        gravitationalWaves = gravitationalWaves.filter(wave => wave.draw(time));
    }
    
    if (isNeutronStar || isCollapsing) {
        drawNeutronStar(time);
        
        if (collapseProgress > 0.5) {
            ctx.globalAlpha = (collapseProgress - 0.5) * 2;
            
            jets.forEach(j => {
                if (j.dir === -1) {
                    j.update();
                    j.draw();
                }
            });
            
            drawBlackHole();
            
            jets.forEach(j => {
                if (j.dir === 1) j.draw();
            });
            
            ctx.globalAlpha = 1;
        }
    } else {
        jets.forEach(j => {
            if (j.dir === -1) {
                j.update();
                j.draw();
            }
        });
        
        accretionParticles.forEach(p => {
            if (Math.sin(p.theta) < -0.1 || p.z < 0) {
                p.update();
                p.draw();
            }
        });
        
        drawBlackHole();
        
        accretionParticles.forEach(p => {
            if (Math.sin(p.theta) >= -0.1 && p.z >= 0) p.draw();
        });
        
        jets.forEach(j => {
            if (j.dir === 1) j.draw();
        });
    }
    
    // Part√≠culas eyectadas
    ejectaParticles = ejectaParticles.filter(p => {
        p.update();
        return p.draw();
    });
    
    // FPS
    frameCount++;
    if (time - lastFpsUpdate > 1000) {
        document.getElementById("fps").textContent = frameCount;
        frameCount = 0;
        lastFpsUpdate = time;
    }
    
    // Mostrar hechos peri√≥dicamente
    factTimer++;
    if (factTimer > 600 && !isCollapsing) { // Cada ~10 segundos
        showFact(currentFactIndex);
        currentFactIndex = (currentFactIndex + 1) % facts.length;
        factTimer = 0;
    }
    
    requestAnimationFrame(animate);
}

/* --- CONTROLES --- */
document.getElementById("collapseBtn").addEventListener("click", startCollapse);

document.getElementById("resetBtn").addEventListener("click", () => {
    isNeutronStar = true;
    isCollapsing = false;
    collapseProgress = 0;
    
    neutronStar = {
        mass: 1.8,
        radius: 60,
        rotationSpeed: 30,
        rotation: 0,
        magneticField: true,
        pulsePhase: 0
    };
    
    neutronParticles = Array.from({ length: 2000 }, () => new NeutronStarParticle());
    accretionParticles = [];
    ejectaParticles = [];
    gravitationalWaves = [];
    gwWaveTimer = 0;
    jets.forEach(j => j.reset());
    
    document.getElementById("objectType").textContent = "‚≠ê ESTRELLA DE NEUTRONES";
    document.getElementById("stateVal").textContent = "ESTABLE";
    document.getElementById("stateVal").style.color = "#0ff";
    document.getElementById("typeVal").textContent = "PULSAR";
    document.getElementById("massVal").textContent = "1.8";
    document.getElementById("radiusVal").textContent = "12";
    document.getElementById("rotationVal").textContent = "30";
    document.getElementById("specialInfo").innerHTML = 
        '<span class="label">üì° PULSOS:</span><span class="val">DETECTADOS</span>';
    document.getElementById("collapseBtn").disabled = false;
    document.getElementById("info").classList.remove("collapsing");
});

document.getElementById("pauseBtn").addEventListener("click", () => {
    paused = !paused;
    document.getElementById("pauseBtn").textContent = paused ? "REANUDAR" : "PAUSAR";
});

// ONDAS GRAVITACIONALES - EFECTO PERMANENTE
document.getElementById("gwBtn").addEventListener("click", () => {
    showGravitationalWaves = !showGravitationalWaves;
    const btn = document.getElementById("gwBtn");
    
    if (showGravitationalWaves) {
        btn.classList.add("active");
        gwWaveTimer = 0; // Reset timer
    } else {
        btn.classList.remove("active");
        gravitationalWaves = []; // Limpiar ondas existentes
    }
});

// LENTE GRAVITACIONAL - EFECTO PERMANENTE
document.getElementById("lensBtn").addEventListener("click", () => {
    showGravitationalLensing = !showGravitationalLensing;
    const btn = document.getElementById("lensBtn");
    
    if (showGravitationalLensing) {
        btn.classList.add("active");
    } else {
        btn.classList.remove("active");
    }
});

// Zoom
canvas.addEventListener("wheel", e => {
    e.preventDefault();
    zoom *= e.deltaY < 0 ? 1.1 : 0.9;
    zoom = Math.max(0.3, Math.min(3, zoom));
});

// Teclado
window.addEventListener("keydown", e => {
    if (e.code === "Space") {
        e.preventDefault();
        document.getElementById("pauseBtn").click();
    } else if (e.code === "KeyE") {
        e.preventDefault();
        startCollapse();
    } else if (e.code === "KeyG") {
        e.preventDefault();
        document.getElementById("gwBtn").click();
    } else if (e.code === "KeyL") {
        e.preventDefault();
        document.getElementById("lensBtn").click();
    }
});

requestAnimationFrame(animate);
</script>
</body>
</html>
